# OpenAPI generated server

## Overview
This server was generated by the [OpenAPI Generator](https://openapi-generator.tech) project. By using the
[OpenAPI-Spec](https://openapis.org) from a remote server, you can easily generate a server stub.  This
is an example of building a OpenAPI-enabled Flask server.

This example uses the [Connexion](https://github.com/zalando/connexion) library on top of Flask.

## Requirements
Python 3.6+

## Usage
To run the server, please execute the following from the root directory:

```
pip3 install -r requirements.txt
python3 -m openapi_server
```

Just pass to the client the following environment variable: `ADDRESS=localhost`.

You can specify [server configuration environment variable](#configuring-the-stub-server-with-environment-variables) values in shell's command line like in the example below:
```
DEFAULT_RATE_LIMIT="300 per second" SERVER_RUN_TIME_IN_SECONDS=120 python3 -m openapi_server
```

To launch the integration tests, use tox:
```
sudo pip install tox
tox
```

You can browse API definition here:

```
http://localhost:8000/ui/
```

Your OpenAPI definition lives here:

```
http://localhost:8000/openapi.json
```

## Configuring the stub server with environment variables

There are the following environment variables which use can use to configure the stub server.

### `SERVER_RUN_TIME_IN_SECONDS`
Time in seconds after which the stub server will stop and print the final balance.
For quick comparison tests it make sense to set it lower than default value, e.g. 2 minutes (`SERVER_RUN_TIME_IN_SECONDS=120`) 

Default value:
`SERVER_RUN_TIME_IN_SECONDS=600`

### `DEFAULT_RATE_LIMIT`
A string representing overall (considering requests to all endpoints) rate limit.
This a configuration string for the `Flask-Limiter`. Please check 
[Rate limit string notation](https://flask-limiter.readthedocs.io/en/stable/#rate-limit-string-notation) for other options.
After the rate limit is reached, the server will return `429 Too Many Requests` response to requests until the request counter 
is reset by the end of a second.

Please note that the example Python client can struggle to achieve the request speed which will hit the default rate limit.
Please consider using `300 per second` to test how a Python client code will react to rate limiting.

Default value:
`DEFAULT_RATE_LIMIT="1000 per second"`

### `SERVER_SEED`
A seed for the stub server's random number generator. Used primarily for treasure map generation.
Also accounts for some random effects like `50x` errors. 

Default value:
`SERVER_SEED=0`

## Running with Docker

To run the server on a Docker container, please execute the following from the root directory:

```bash
# building the image
docker build -t hlc21_stub_server .

# starting up a container (with an environment variable value override)
docker run --rm -it -e SERVER_RUN_TIME_IN_SECONDS=120 -p 0.0.0.0:8000:8000 hlc21_stub_server
```

## Running with Docker Compose

There's an example Docker Compose file located in the sample client's folder: [docker-compose.yaml](../python/docker-compose.yaml).
You can copy it to your client's folder, tailor it (adjust the client container image name and relative paths) and run 
both the stub server and your client in one go using the following command:
```bash
docker compose down && docker compose build && docker compose up
```
